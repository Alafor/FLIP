<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hk.flip.Inclass">

	<select id="chkinclass" parameterType="Map" resultType="java.lang.Integer">
		 SELECT  b.class_now_participation
         FROM class a,(SELECT COUNT(inclass.inclass_class_seq) AS class_now_participation FROM inclass WHERE inclass.inclass_class_seq = #{seq}) b
         WHERE a.seq = #{seq} and b.class_now_participation <![CDATA[>=]]> a.class_participation;
	</select>
	
	<select id="chkinclasstime_join" parameterType="Map" resultType="java.lang.Integer">
		SELECT (SELECT COUNT(inclass.seq) FROM inclass WHERE inclass.seq = class.seq) 
		AS now_participation FROM class WHERE class.seq = #{seq} and now_participation <![CDATA[>=]]> class.participation
	</select>
	<select id="chkinclasstime_join" parameterType="Map" resultType="java.lang.Integer">
		SELECT class_name FROM class 
        WHERE 
        class_member_seq = #{member_seq}   
        and CLASS_SD<![CDATA[<=]]>to_date(#{class_cd},'yyyy-mm-dd') and (CLASS_CD<![CDATA[>=]]>to_date(#{class_sd},'yyyy-mm-dd'))
        and (to_date(class_starttime, 'hh24mi') <![CDATA[<=]]> (to_date(#{class_starttime}, 'hh24mi')+#{class_time}/(24*60)) 
        and  ( to_date(class_starttime, 'hh24mi')+class_time/(24*60))<![CDATA[>=]]>(to_date(#{class_starttime}, 'hh24mi')))
        and CLASS_WEEK in
        <foreach collection="weeks" item="week" open="(" separator="," close=")">
			#{week}
		</foreach>
	</select>

	<select id="chkinclasstime_create" parameterType="Map" resultType="String">
		SELECT class_name FROM class 
        WHERE 
        class_member_seq = #{member_seq}   
        and CLASS_SD<![CDATA[<=]]>to_date(#{class_cd},'yyyy-mm-dd') and (CLASS_CD<![CDATA[>=]]>to_date(#{class_sd},'yyyy-mm-dd'))
        and (to_date(class_starttime, 'hh24mi') <![CDATA[<=]]> (to_date(#{class_starttime}, 'hh24mi')+#{class_time}/(24*60)) 
        and  ( to_date(class_starttime, 'hh24mi')+class_time/(24*60))<![CDATA[>=]]>(to_date(#{class_starttime}, 'hh24mi')))
        and CLASS_WEEK in
        <foreach collection="weeks" item="week" open="(" separator="," close=")">
			#{week}
		</foreach>
	</select>

	<insert id="insertinclass" parameterType="Map">
		INSERT INTO inclass (inclass_member_seq,inclass_class_seq) VALUES( #{member_seq},#{class_seq}) 
	</insert>
	
	<select id="getinclasslist">
	SELECT 
		a.class_type,a.seq, a.class_name,a.regdate, a.class_info, a.class_area, a.class_depa 
		, a.class_sd , a.class_cd, a.class_week
		, a.class_starttime , a.class_time
		, a.class_price, a.class_PARTICIPATION, a.class_detail, a.class_img , a.class_hashtag, a.class_termin,
			NVL(b.rating,0) as rating,	
			c.participation,
			c.d_day
		  FROM (SELECT class_type, seq, class_name, regdate, class_info, class_area, class_depa 
		, class_sd , class_cd, class_week
		, class_starttime , class_time
		, class_price, class_PARTICIPATION, class_detail, class_img , class_hashtag, class_termin,CLASS_MEMBER_SEQ  FROM class WHERE seq in(SELECT INCLASS_CLASS_SEQ FROM INclass 
		 WHERE INCLASS_MEMBER_SEQ= 2)) a,
		 (SELECT CLASS.CLASS_MEMBER_SEQ, ROUND(AVG(REVIEW.REVIEW_RATING),1) AS RATING FROM REVIEW, CLASS WHERE REVIEW.REVIEW_CLASS_SEQ = CLASS.SEQ GROUP BY CLASS.CLASS_MEMBER_SEQ) b,
		  (SELECT seq,	(SELECT COUNT(inclass.inclass_class_seq) FROM INCLASS WHERE INCLASS.INCLASS_CLASS_SEQ = CLASS.SEQ) AS participation, (TO_CHAR(CLASS.CLASS_SD,'YYYYMMDD')-TO_CHAR(SYSDATE,'YYYYMMDD')) AS d_day
			FROM CLASS) c
		 WHERE a.CLASS_MEMBER_SEQ = b.CLASS_MEMBER_SEQ (+)
			AND
         a.SEQ = c.SEQ
	</select>
	
	<delete id="delmyinclass" parameterType="Map">
		DELETE FROM inclass WHERE inclass_member_seq = #{member_seqs[0]} AND inclass_class_seq IN
		<foreach collection="class_seqs" item="class_seq" open="(" separator="," close=")">
			#{class_seq}
		</foreach>
	</delete>
</mapper>